#define _GNU_SOURCE
#include <stdio.h>
#include <sched.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>

void print_hex_bytes(uint8_t *buf, int l, int r)
{
    for(int i = l; i < r; i+=0x10)
    {
        for(int j = 0; j < 0x10 && i + j < r; j++)
        {
            printf("%02x ", buf[i+j]);
        }
        printf("\n");
    }
}

void print_hex_8bytes(uint64_t *buf, int l, int r)
{
    for(int i=l; i<r; i++)
    {
        printf("0x%03x: 0x%016lx\n", i, buf[i]);
    }
}

void cpu_affinity(int cpu)
{
    cpu_set_t mask;
    CPU_ZERO(&mask);
    CPU_SET(cpu, &mask);
    if (sched_setaffinity(0, sizeof(mask), &mask) < 0)
        perror("sched_setaffinity");
}


void unshare_setup(int flags)
{
	int temp;
	char edit[0x100];

	if(unshare(flags) < 0)
        perror("unshare");

	temp = open("/proc/self/setgroups", O_WRONLY);
	if(write(temp, "deny", strlen("deny")))
        perror("setgroups");
	close(temp);

	temp = open("/proc/self/uid_map", O_WRONLY);
	snprintf(edit, sizeof(edit), "0 %d 1", getuid());
	if(write(temp, edit, strlen(edit)))
        perror("uid_map");
	close(temp);

	temp = open("/proc/self/gid_map", O_WRONLY);
	snprintf(edit, sizeof(edit), "0 %d 1", getgid());
	if(write(temp, edit, strlen(edit)) < 0)
        perror("gid_map");
	close(temp);

	return;
}